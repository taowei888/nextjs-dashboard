# 数据获取文档

## 概述
本文档详细介绍 Next.js 仪表板项目中的数据获取模式和实现方式，涵盖数据获取的完整流程。

## 数据获取架构

### 数据层结构
```
app/
├── lib/
│   ├── data.ts          # 主要数据获取函数
│   ├── definitions.ts   # TypeScript 类型定义
│   └── utils.ts         # 工具函数（如 formatCurrency）
├── dashboard/
│   └── page.tsx         # 仪表板页面（数据消费者）
└── query/
    └── route.ts         # API 路由（新增查询端点）
```

## 核心数据获取函数

### 1. 仪表板数据获取
在 `app/dashboard/page.tsx:6-9,12-19` 中使用的主要数据获取：

```typescript
import {
  fetchRevenue,
  fetchLatestInvoices,
  fetchCardData,
} from "@/app/lib/data";

// 服务器端数据获取
const revenue = await fetchRevenue();
const latestInvoices = await fetchLatestInvoices();
const {
  numberOfInvoices,
  numberOfCustomers,
  totalPaidInvoices,
  totalPendingInvoices,
} = await fetchCardData();
```

### 2. 数据获取函数详解

#### fetchRevenue() - 收入数据
```typescript
// app/lib/data.ts:14-31
export async function fetchRevenue() {
  try {
    const data = await sql<Revenue[]>`SELECT * FROM revenue`;
    return data;
  } catch (error) {
    console.error('Database Error:', error);
    throw new Error('Failed to fetch revenue data.');
  }
}
```
- **用途**：获取月度收入数据用于收入图表
- **返回类型**：`Revenue[]`
- **UI 组件**：`RevenueChart` (`app/dashboard/page.tsx:36`)

#### fetchLatestInvoices() - 最新发票
```typescript
// app/lib/data.ts:33-51
export async function fetchLatestInvoices() {
  try {
    const data = await sql<LatestInvoiceRaw[]>`
      SELECT invoices.amount, customers.name, customers.image_url, customers.email, invoices.id
      FROM invoices
      JOIN customers ON invoices.customer_id = customers.id
      ORDER BY invoices.date DESC
      LIMIT 5`;

    const latestInvoices = data.map((invoice) => ({
      ...invoice,
      amount: formatCurrency(invoice.amount),
    }));
    return latestInvoices;
  } catch (error) {
    console.error('Database Error:', error);
    throw new Error('Failed to fetch the latest invoices.');
  }
}
```
- **用途**：获取最新 5 条发票记录
- **数据转换**：金额从分转换为格式化的美元字符串
- **UI 组件**：`LatestInvoices` (`app/dashboard/page.tsx:37`)

#### fetchCardData() - 卡片统计数据
```typescript
// app/lib/data.ts:53-86
export async function fetchCardData() {
  try {
    // 并行查询优化
    const invoiceCountPromise = sql`SELECT COUNT(*) FROM invoices`;
    const customerCountPromise = sql`SELECT COUNT(*) FROM customers`;
    const invoiceStatusPromise = sql`SELECT
         SUM(CASE WHEN status = 'paid' THEN amount ELSE 0 END) AS "paid",
         SUM(CASE WHEN status = 'pending' THEN amount ELSE 0 END) AS "pending"
         FROM invoices`;

    const data = await Promise.all([
      invoiceCountPromise,
      customerCountPromise,
      invoiceStatusPromise,
    ]);

    return {
      numberOfCustomers: Number(data[1][0].count ?? '0'),
      numberOfInvoices: Number(data[0][0].count ?? '0'),
      totalPaidInvoices: formatCurrency(data[2][0].paid ?? '0'),
      totalPendingInvoices: formatCurrency(data[2][0].pending ?? '0'),
    };
  } catch (error) {
    console.error('Database Error:', error);
    throw new Error('Failed to fetch card data.');
  }
}
```
- **用途**：获取仪表板统计卡片数据
- **性能优化**：使用 `Promise.all` 并行执行多个查询
- **UI 组件**：`Card` 组件 (`app/dashboard/page.tsx:26-33`)

## API 查询端点

### 直接查询 API
项目包含了直接查询 API 端点：

```typescript
// app/query/route.ts:5-14,21-25
import postgres from 'postgres';

const sql = postgres(process.env.POSTGRES_URL!, { ssl: 'require' });

async function listInvoices() {
  const data = await sql`
    SELECT invoices.amount, customers.name
    FROM invoices
    JOIN customers ON invoices.customer_id = customers.id
    WHERE invoices.amount = 666;
  `;
  return data;
}

export async function GET() {
  try {
    return Response.json(await listInvoices());
  } catch (error) {
    return Response.json({ error }, { status: 500 });
  }
}
```

**API 端点详情：**
- **路径**：`GET /query`
- **功能**：查询特定金额（666分）的发票及客户信息
- **响应格式**：JSON
- **错误处理**：返回 500 状态码和错误信息

## 数据获取模式

### 1. 服务器端渲染 (SSR)
```typescript
// app/dashboard/page.tsx:11
export default async function Page() {
  // 在服务器端获取数据
  const revenue = await fetchRevenue();
  // 直接传递给组件
}
```

### 2. 并行数据获取
```typescript
// 同时获取多个数据源
const revenue = await fetchRevenue();           // 独立查询
const latestInvoices = await fetchLatestInvoices(); // 独立查询
const cardData = await fetchCardData();         // 内部并行查询
```

### 3. API 路由数据获取
```typescript
// 客户端可以调用
fetch('/query')
  .then(res => res.json())
  .then(data => console.log(data));
```

## 数据转换和格式化

### 金额处理
```typescript
// 数据库存储：以分为单位
// 显示转换：formatCurrency() 函数
const latestInvoices = data.map((invoice) => ({
  ...invoice,
  amount: formatCurrency(invoice.amount), // 66600 → "$666.00"
}));
```

### 类型安全
```typescript
// 严格的 TypeScript 类型
const data = await sql<Revenue[]>`SELECT * FROM revenue`;
const cardData = await sql<LatestInvoiceRaw[]>`...`;
```

## 分页数据获取

### 发票分页查询
```typescript
// app/lib/data.ts:89-122
const ITEMS_PER_PAGE = 6;

export async function fetchFilteredInvoices(
  query: string,
  currentPage: number,
) {
  const offset = (currentPage - 1) * ITEMS_PER_PAGE;

  const invoices = await sql<InvoicesTable[]>`
    SELECT ... FROM invoices
    JOIN customers ON invoices.customer_id = customers.id
    WHERE ... ILIKE ${`%${query}%`}
    ORDER BY invoices.date DESC
    LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}
  `;
}
```

### 页数计算
```typescript
// app/lib/data.ts:124-143
export async function fetchInvoicesPages(query: string) {
  const data = await sql`SELECT COUNT(*) FROM invoices ...`;
  const totalPages = Math.ceil(Number(data[0].count) / ITEMS_PER_PAGE);
  return totalPages;
}
```

## 错误处理策略

### 统一错误处理模式
```typescript
try {
  // 数据库查询
  const data = await sql`...`;
  return data;
} catch (error) {
  console.error('Database Error:', error);
  throw new Error('Failed to fetch [specific data type].');
}
```

### API 路由错误处理
```typescript
export async function GET() {
  try {
    return Response.json(await listInvoices());
  } catch (error) {
    return Response.json({ error }, { status: 500 });
  }
}
```

## 性能优化策略

### 1. 并行查询
```typescript
// ✅ 好的做法：并行执行
const data = await Promise.all([
  invoiceCountPromise,
  customerCountPromise,
  invoiceStatusPromise,
]);

// ❌ 避免：串行执行
const count1 = await sql`...`;
const count2 = await sql`...`;
const count3 = await sql`...`;
```

### 2. 数据限制
```typescript
// 限制返回数据量
ORDER BY invoices.date DESC LIMIT 5    // 最新发票
LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset} // 分页
```

### 3. 索引查询
```typescript
// 使用主键和外键查询
WHERE invoices.id = ${id}
WHERE invoices.customer_id = customers.id
```

## 项目功能总结

### ✅ 已实现功能
1. **Query API 端点** - `app/query/route.ts` 提供直接查询接口
2. **数据库连接** - PostgreSQL 连接已配置完成
3. **类型安全查询** - 使用 TypeScript 类型注解

### 📊 数据流向
```
数据库 (PostgreSQL)
    ↓
数据获取函数 (app/lib/data.ts)
    ↓
页面组件 (app/dashboard/page.tsx)
    ↓
UI 组件 (Cards, Charts, Lists)
```

### 🔗 API 数据流
```
客户端请求
    ↓
API 路由 (app/query/route.ts)
    ↓
数据库查询
    ↓
JSON 响应
```

## 开发建议

1. **数据获取优化**：优先使用服务器端数据获取 (SSR)
2. **并行查询**：对于独立数据源使用 `Promise.all`
3. **错误边界**：为每个数据获取函数添加错误处理
4. **类型安全**：始终使用 TypeScript 类型注解
5. **性能监控**：监控数据库查询性能和响应时间