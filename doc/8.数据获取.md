# æ•°æ®è·å–æ–‡æ¡£

## æ¦‚è¿°
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» Next.js ä»ªè¡¨æ¿é¡¹ç›®ä¸­çš„æ•°æ®è·å–æ¨¡å¼å’Œå®ç°æ–¹å¼ï¼Œæ¶µç›–æ•°æ®è·å–çš„å®Œæ•´æµç¨‹ã€‚

## æ•°æ®è·å–æ¶æ„

### æ•°æ®å±‚ç»“æ„
```
app/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ data.ts          # ä¸»è¦æ•°æ®è·å–å‡½æ•°
â”‚   â”œâ”€â”€ definitions.ts   # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ utils.ts         # å·¥å…·å‡½æ•°ï¼ˆå¦‚ formatCurrencyï¼‰
â”œâ”€â”€ dashboard/
â”‚   â””â”€â”€ page.tsx         # ä»ªè¡¨æ¿é¡µé¢ï¼ˆæ•°æ®æ¶ˆè´¹è€…ï¼‰
â””â”€â”€ query/
    â””â”€â”€ route.ts         # API è·¯ç”±ï¼ˆæ–°å¢æŸ¥è¯¢ç«¯ç‚¹ï¼‰
```

## æ ¸å¿ƒæ•°æ®è·å–å‡½æ•°

### 1. ä»ªè¡¨æ¿æ•°æ®è·å–
åœ¨ `app/dashboard/page.tsx:6-9,12-19` ä¸­ä½¿ç”¨çš„ä¸»è¦æ•°æ®è·å–ï¼š

```typescript
import {
  fetchRevenue,
  fetchLatestInvoices,
  fetchCardData,
} from "@/app/lib/data";

// æœåŠ¡å™¨ç«¯æ•°æ®è·å–
const revenue = await fetchRevenue();
const latestInvoices = await fetchLatestInvoices();
const {
  numberOfInvoices,
  numberOfCustomers,
  totalPaidInvoices,
  totalPendingInvoices,
} = await fetchCardData();
```

### 2. æ•°æ®è·å–å‡½æ•°è¯¦è§£

#### fetchRevenue() - æ”¶å…¥æ•°æ®
```typescript
// app/lib/data.ts:14-31
export async function fetchRevenue() {
  try {
    const data = await sql<Revenue[]>`SELECT * FROM revenue`;
    return data;
  } catch (error) {
    console.error('Database Error:', error);
    throw new Error('Failed to fetch revenue data.');
  }
}
```
- **ç”¨é€”**ï¼šè·å–æœˆåº¦æ”¶å…¥æ•°æ®ç”¨äºæ”¶å…¥å›¾è¡¨
- **è¿”å›ç±»å‹**ï¼š`Revenue[]`
- **UI ç»„ä»¶**ï¼š`RevenueChart` (`app/dashboard/page.tsx:36`)

#### fetchLatestInvoices() - æœ€æ–°å‘ç¥¨
```typescript
// app/lib/data.ts:33-51
export async function fetchLatestInvoices() {
  try {
    const data = await sql<LatestInvoiceRaw[]>`
      SELECT invoices.amount, customers.name, customers.image_url, customers.email, invoices.id
      FROM invoices
      JOIN customers ON invoices.customer_id = customers.id
      ORDER BY invoices.date DESC
      LIMIT 5`;

    const latestInvoices = data.map((invoice) => ({
      ...invoice,
      amount: formatCurrency(invoice.amount),
    }));
    return latestInvoices;
  } catch (error) {
    console.error('Database Error:', error);
    throw new Error('Failed to fetch the latest invoices.');
  }
}
```
- **ç”¨é€”**ï¼šè·å–æœ€æ–° 5 æ¡å‘ç¥¨è®°å½•
- **æ•°æ®è½¬æ¢**ï¼šé‡‘é¢ä»åˆ†è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„ç¾å…ƒå­—ç¬¦ä¸²
- **UI ç»„ä»¶**ï¼š`LatestInvoices` (`app/dashboard/page.tsx:37`)

#### fetchCardData() - å¡ç‰‡ç»Ÿè®¡æ•°æ®
```typescript
// app/lib/data.ts:53-86
export async function fetchCardData() {
  try {
    // å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŒ–
    const invoiceCountPromise = sql`SELECT COUNT(*) FROM invoices`;
    const customerCountPromise = sql`SELECT COUNT(*) FROM customers`;
    const invoiceStatusPromise = sql`SELECT
         SUM(CASE WHEN status = 'paid' THEN amount ELSE 0 END) AS "paid",
         SUM(CASE WHEN status = 'pending' THEN amount ELSE 0 END) AS "pending"
         FROM invoices`;

    const data = await Promise.all([
      invoiceCountPromise,
      customerCountPromise,
      invoiceStatusPromise,
    ]);

    return {
      numberOfCustomers: Number(data[1][0].count ?? '0'),
      numberOfInvoices: Number(data[0][0].count ?? '0'),
      totalPaidInvoices: formatCurrency(data[2][0].paid ?? '0'),
      totalPendingInvoices: formatCurrency(data[2][0].pending ?? '0'),
    };
  } catch (error) {
    console.error('Database Error:', error);
    throw new Error('Failed to fetch card data.');
  }
}
```
- **ç”¨é€”**ï¼šè·å–ä»ªè¡¨æ¿ç»Ÿè®¡å¡ç‰‡æ•°æ®
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ `Promise.all` å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæŸ¥è¯¢
- **UI ç»„ä»¶**ï¼š`Card` ç»„ä»¶ (`app/dashboard/page.tsx:26-33`)

## API æŸ¥è¯¢ç«¯ç‚¹

### ç›´æ¥æŸ¥è¯¢ API
é¡¹ç›®åŒ…å«äº†ç›´æ¥æŸ¥è¯¢ API ç«¯ç‚¹ï¼š

```typescript
// app/query/route.ts:5-14,21-25
import postgres from 'postgres';

const sql = postgres(process.env.POSTGRES_URL!, { ssl: 'require' });

async function listInvoices() {
  const data = await sql`
    SELECT invoices.amount, customers.name
    FROM invoices
    JOIN customers ON invoices.customer_id = customers.id
    WHERE invoices.amount = 666;
  `;
  return data;
}

export async function GET() {
  try {
    return Response.json(await listInvoices());
  } catch (error) {
    return Response.json({ error }, { status: 500 });
  }
}
```

**API ç«¯ç‚¹è¯¦æƒ…ï¼š**
- **è·¯å¾„**ï¼š`GET /query`
- **åŠŸèƒ½**ï¼šæŸ¥è¯¢ç‰¹å®šé‡‘é¢ï¼ˆ666åˆ†ï¼‰çš„å‘ç¥¨åŠå®¢æˆ·ä¿¡æ¯
- **å“åº”æ ¼å¼**ï¼šJSON
- **é”™è¯¯å¤„ç†**ï¼šè¿”å› 500 çŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯

## æ•°æ®è·å–æ¨¡å¼

### 1. æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)
```typescript
// app/dashboard/page.tsx:11
export default async function Page() {
  // åœ¨æœåŠ¡å™¨ç«¯è·å–æ•°æ®
  const revenue = await fetchRevenue();
  // ç›´æ¥ä¼ é€’ç»™ç»„ä»¶
}
```

### 2. å¹¶è¡Œæ•°æ®è·å–
```typescript
// åŒæ—¶è·å–å¤šä¸ªæ•°æ®æº
const revenue = await fetchRevenue();           // ç‹¬ç«‹æŸ¥è¯¢
const latestInvoices = await fetchLatestInvoices(); // ç‹¬ç«‹æŸ¥è¯¢
const cardData = await fetchCardData();         // å†…éƒ¨å¹¶è¡ŒæŸ¥è¯¢
```

### 3. API è·¯ç”±æ•°æ®è·å–
```typescript
// å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨
fetch('/query')
  .then(res => res.json())
  .then(data => console.log(data));
```

## æ•°æ®è½¬æ¢å’Œæ ¼å¼åŒ–

### é‡‘é¢å¤„ç†
```typescript
// æ•°æ®åº“å­˜å‚¨ï¼šä»¥åˆ†ä¸ºå•ä½
// æ˜¾ç¤ºè½¬æ¢ï¼šformatCurrency() å‡½æ•°
const latestInvoices = data.map((invoice) => ({
  ...invoice,
  amount: formatCurrency(invoice.amount), // 66600 â†’ "$666.00"
}));
```

### ç±»å‹å®‰å…¨
```typescript
// ä¸¥æ ¼çš„ TypeScript ç±»å‹
const data = await sql<Revenue[]>`SELECT * FROM revenue`;
const cardData = await sql<LatestInvoiceRaw[]>`...`;
```

## åˆ†é¡µæ•°æ®è·å–

### å‘ç¥¨åˆ†é¡µæŸ¥è¯¢
```typescript
// app/lib/data.ts:89-122
const ITEMS_PER_PAGE = 6;

export async function fetchFilteredInvoices(
  query: string,
  currentPage: number,
) {
  const offset = (currentPage - 1) * ITEMS_PER_PAGE;

  const invoices = await sql<InvoicesTable[]>`
    SELECT ... FROM invoices
    JOIN customers ON invoices.customer_id = customers.id
    WHERE ... ILIKE ${`%${query}%`}
    ORDER BY invoices.date DESC
    LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}
  `;
}
```

### é¡µæ•°è®¡ç®—
```typescript
// app/lib/data.ts:124-143
export async function fetchInvoicesPages(query: string) {
  const data = await sql`SELECT COUNT(*) FROM invoices ...`;
  const totalPages = Math.ceil(Number(data[0].count) / ITEMS_PER_PAGE);
  return totalPages;
}
```

## é”™è¯¯å¤„ç†ç­–ç•¥

### ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
```typescript
try {
  // æ•°æ®åº“æŸ¥è¯¢
  const data = await sql`...`;
  return data;
} catch (error) {
  console.error('Database Error:', error);
  throw new Error('Failed to fetch [specific data type].');
}
```

### API è·¯ç”±é”™è¯¯å¤„ç†
```typescript
export async function GET() {
  try {
    return Response.json(await listInvoices());
  } catch (error) {
    return Response.json({ error }, { status: 500 });
  }
}
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å¹¶è¡ŒæŸ¥è¯¢
```typescript
// âœ… å¥½çš„åšæ³•ï¼šå¹¶è¡Œæ‰§è¡Œ
const data = await Promise.all([
  invoiceCountPromise,
  customerCountPromise,
  invoiceStatusPromise,
]);

// âŒ é¿å…ï¼šä¸²è¡Œæ‰§è¡Œ
const count1 = await sql`...`;
const count2 = await sql`...`;
const count3 = await sql`...`;
```

### 2. æ•°æ®é™åˆ¶
```typescript
// é™åˆ¶è¿”å›æ•°æ®é‡
ORDER BY invoices.date DESC LIMIT 5    // æœ€æ–°å‘ç¥¨
LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset} // åˆ†é¡µ
```

### 3. ç´¢å¼•æŸ¥è¯¢
```typescript
// ä½¿ç”¨ä¸»é”®å’Œå¤–é”®æŸ¥è¯¢
WHERE invoices.id = ${id}
WHERE invoices.customer_id = customers.id
```

## é¡¹ç›®åŠŸèƒ½æ€»ç»“

### âœ… å·²å®ç°åŠŸèƒ½
1. **Query API ç«¯ç‚¹** - `app/query/route.ts` æä¾›ç›´æ¥æŸ¥è¯¢æ¥å£
2. **æ•°æ®åº“è¿æ¥** - PostgreSQL è¿æ¥å·²é…ç½®å®Œæˆ
3. **ç±»å‹å®‰å…¨æŸ¥è¯¢** - ä½¿ç”¨ TypeScript ç±»å‹æ³¨è§£

### ğŸ“Š æ•°æ®æµå‘
```
æ•°æ®åº“ (PostgreSQL)
    â†“
æ•°æ®è·å–å‡½æ•° (app/lib/data.ts)
    â†“
é¡µé¢ç»„ä»¶ (app/dashboard/page.tsx)
    â†“
UI ç»„ä»¶ (Cards, Charts, Lists)
```

### ğŸ”— API æ•°æ®æµ
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API è·¯ç”± (app/query/route.ts)
    â†“
æ•°æ®åº“æŸ¥è¯¢
    â†“
JSON å“åº”
```

## å¼€å‘å»ºè®®

1. **æ•°æ®è·å–ä¼˜åŒ–**ï¼šä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨ç«¯æ•°æ®è·å– (SSR)
2. **å¹¶è¡ŒæŸ¥è¯¢**ï¼šå¯¹äºç‹¬ç«‹æ•°æ®æºä½¿ç”¨ `Promise.all`
3. **é”™è¯¯è¾¹ç•Œ**ï¼šä¸ºæ¯ä¸ªæ•°æ®è·å–å‡½æ•°æ·»åŠ é”™è¯¯å¤„ç†
4. **ç±»å‹å®‰å…¨**ï¼šå§‹ç»ˆä½¿ç”¨ TypeScript ç±»å‹æ³¨è§£
5. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½å’Œå“åº”æ—¶é—´