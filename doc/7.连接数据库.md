# 数据库连接文档

## 概述
本项目使用 PostgreSQL 数据库，通过 `postgres` 库进行连接和查询操作。

## 数据库配置

### 环境变量设置
项目需要以下环境变量进行数据库连接：

```bash
# 主要连接URL（必需）
POSTGRES_URL=your_database_connection_string

# 可选的其他连接配置
POSTGRES_PRISMA_URL=your_prisma_connection_string
POSTGRES_URL_NON_POOLING=your_non_pooling_connection_string
POSTGRES_USER=your_username
POSTGRES_HOST=your_host
POSTGRES_PASSWORD=your_password
POSTGRES_DATABASE=your_database_name
```

### 连接配置
数据库连接在 `app/lib/data.ts:12` 中配置：

```typescript
const sql = postgres(process.env.POSTGRES_URL!, { ssl: 'require' });
```

**重要配置项：**
- 使用 `POSTGRES_URL` 环境变量
- 强制启用 SSL 连接 (`ssl: 'require'`)
- 使用非空断言操作符 (`!`) 确保环境变量存在

## 数据库结构

### 主要数据表
项目包含以下主要数据表及其类型定义：

#### 1. Users 表
```typescript
type User = {
  id: string;
  name: string;
  email: string;
  password: string;
};
```

#### 2. Customers 表
```typescript
type Customer = {
  id: string;
  name: string;
  email: string;
  image_url: string;
};
```

#### 3. Invoices 表
```typescript
type Invoice = {
  id: string;
  customer_id: string;
  amount: number;        // 以分为单位存储
  date: string;
  status: 'pending' | 'paid';
};
```

#### 4. Revenue 表
```typescript
type Revenue = {
  month: string;
  revenue: number;
};
```

## 数据访问层

### 主要查询函数 (`app/lib/data.ts`)

1. **fetchRevenue()** - 获取收入数据
2. **fetchLatestInvoices()** - 获取最新发票（限制5条）
3. **fetchCardData()** - 获取仪表板卡片统计数据
4. **fetchFilteredInvoices(query, currentPage)** - 分页查询发票
5. **fetchInvoicesPages(query)** - 计算发票总页数
6. **fetchInvoiceById(id)** - 根据ID获取单个发票
7. **fetchCustomers()** - 获取所有客户
8. **fetchFilteredCustomers(query)** - 搜索客户

### 查询API端点
新增查询端点 `app/query/route.ts` 提供直接数据库查询接口：

```typescript
// GET /query
// 功能：查询金额为666的发票及对应客户信息
async function listInvoices() {
  const data = await sql`
    SELECT invoices.amount, customers.name
    FROM invoices
    JOIN customers ON invoices.customer_id = customers.id
    WHERE invoices.amount = 666;
  `;
  return data;
}
```

## 数据处理规范

### 金额处理
- **存储**：金额以分为单位存储在数据库中
- **显示**：通过 `formatCurrency()` 函数转换为美元显示
- **示例**：数据库存储 `66600` 表示 `$666.00`

### 分页配置
- 每页显示条目数：`ITEMS_PER_PAGE = 6`
- 分页偏移计算：`offset = (currentPage - 1) * ITEMS_PER_PAGE`

### 错误处理
所有数据库查询函数都包含标准错误处理：
```typescript
try {
  // 数据库查询
} catch (error) {
  console.error('Database Error:', error);
  throw new Error('具体错误信息');
}
```

## 安全措施

1. **参数化查询**：所有查询使用模板字符串参数化，防止SQL注入
2. **SSL连接**：强制使用SSL连接确保数据传输安全
3. **环境变量**：敏感连接信息通过环境变量管理

## 最近更改

根据 Git 历史，最近的数据库相关更改：
- ✅ 激活了 `/query` 路由的数据库查询功能
- ✅ 移除了 `.env.example` 文件
- ✅ 启用了发票查询API端点

## 开发注意事项

1. 确保 `POSTGRES_URL` 环境变量正确配置
2. 生产环境必须使用SSL连接
3. 金额计算时注意分与美元的转换
4. 查询大数据集时考虑分页和性能优化
5. 所有数据库操作都应包含适当的错误处理